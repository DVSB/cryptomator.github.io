"use strict";const STRIPE_PK='pk_live_eSasX216vGvC26GdbVwA011V';const STRIPE_PLANS={'EUR':'plan_GgW4ovr7c6upzx','USD':'plan_GgW49BkhumHMIR'};const STRIPE_PHP_URL='https://api.cryptomator.org/stripe/prepare_payment.php';const RECAPTCHA_SITEKEY='6LfbD3sUAAAAAMEH2DZWFtyDOS5TXB38fj85coqv';class OneTimePayment{constructor(status){this._status=status;}
initStripeField(placeholder,placeholderLoading,languageCode){let cardElement=document.createElement('div');$(cardElement).hide();$(placeholder).after(cardElement);$(placeholder).attr('placeholder',placeholderLoading);$(placeholder).attr('disabled',true);this._stripe=$.ajax({url:'https://js.stripe.com/v3/',cache:true,dataType:'script'}).then(response=>{return window.Stripe(STRIPE_PK);});this._card=this._stripe.then(stripe=>{let card=stripe.elements({locale:languageCode}).create('card',{style:{base:{fontFamily:'Open Sans, sans-serif',fontSize:'16px',lineHeight:'1.5'}}});card.mount(cardElement);card.on('ready',event=>{$(cardElement).show();$(placeholder).hide();card.focus();});card.on('change',this.onCardChanged.bind(this));return card;});}
onCardChanged(event){this._status.validCardNum=event.complete;if(event.error){this._status.errorMessage=event.error.message;}else{this._status.errorMessage='';}}
loadRecaptcha(wrapper){window.grecaptchaCallback=()=>{$(wrapper).empty();grecaptcha.render(wrapper,{'sitekey':RECAPTCHA_SITEKEY,'data-size':'compact','callback':(captcha)=>this._status.captcha=captcha});}
$.getScript("https://www.google.com/recaptcha/api.js?onload=grecaptchaCallback&render=explicit");}
charge(amount,currency){this._status.inProgress=true;this._status.errorMessage='';this._status.success=false;let preparedPayment=$.ajax({url:STRIPE_PHP_URL,type:'POST',data:{currency:currency,amount:amount,captcha:this._status.captcha}});Promise.all([this._stripe,this._card,preparedPayment]).then(([stripe,card,preparedPayment])=>{stripe.confirmCardPayment(preparedPayment.client_secret,{payment_method:{card:card}}).then(function(result){if(result.error){this.onPaymentFailed(result.error);}else{if(result.paymentIntent.status==='succeeded'){this.onPaymentSucceeded();}}}.bind(this));});}
onPaymentFailed(error){console.warn('Stripe payment failed with error',error);this._status.success=false;this._status.errorMessage=error.message;this._status.inProgress=false;if(grecaptcha){this._status.captcha='';grecaptcha.reset();}}
onPaymentSucceeded(){console.info('Stripe payment succeeded!');this._status.success=true;this._status.errorMessage='';this._status.inProgress=false;if(grecaptcha){this._status.captcha='';grecaptcha.reset();}}}
class RecurringPayment{checkout(amount,currency){let plan=STRIPE_PLANS[currency];$.ajax({url:'https://js.stripe.com/v3/',cache:true,dataType:'script'}).then(response=>{return window.Stripe(STRIPE_PK);}).then(stripe=>{stripe.redirectToCheckout({items:[{plan:plan,quantity:parseInt(amount)}],successUrl:window.location.href+'/thanks',cancelUrl:window.location.href}).then(result=>{if(result.error){console.log(result.error.message);}});});}}